<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‚Äî One File v1.2 (CORS Fixed + Dedup + 4 Patches)</title>
<style>
  :root { --bg:#0b0b0f; --card:#14141a; --muted:#8b8b94; --text:#eaeaf1; --accent:#5ee391; --danger:#ff6b6b; --line:#23232a; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{padding:16px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid #222}
  h1{font-size:20px;margin:0}
  .right{display:flex;gap:8px;align-items:center}
  button, select, input{font:inherit}
  button{padding:8px 12px;border-radius:12px;border:1px solid #333;background:#1d1d25;color:var(--text);cursor:pointer}
  button.primary{background:#1c2a21;border-color:#284130}
  button.ghost{background:transparent;border-color:#333}
  button.warn{background:#2a1414;border-color:#402828;color:#ffb3b3}
  button:disabled{opacity:.6;cursor:not-allowed}
  .status{font-size:12px;color:var(--muted)}
  .wrap{padding:16px;max-width:1100px;margin:0 auto}
  .tabs{display:flex;gap:8px;margin:12px 0 16px}
  .tabs button{border-radius:999px;padding:8px 14px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card h2{margin:0 0 10px 0;font-size:16px}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
  input, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a33;background:#111018;color:var(--text)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  td.num{text-align:right}
  .ok{color:var(--accent)} .bad{color:var(--danger)}
  .muted{color:var(--muted)}
  .pill{display:inline-block;border:1px solid #333;border-radius:999px;padding:2px 8px;font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grow{flex:1 1 auto}
  .avatar{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#1b1b22;border:1px solid #2b2b33;font-size:16px}
  .avatar img{width:100%;height:100%;object-fit:cover;border-radius:8px;display:block}
  .tiny{font-size:12px}
  .link{color:#9ad7ff;text-decoration:underline;cursor:pointer}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .modal{width:min(560px,100%);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .modal h3{margin:0 0 8px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  /* emoji */
  .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:8px;background:#0f0f15}
  .emoji-btn{font-size:20px;background:#15151c;border:1px solid #2a2a33;border-radius:10px;cursor:pointer;padding:6px}
  .emoji-btn:hover{transform:translateY(-1px)}
  @media (max-width:900px){ .g3{grid-template-columns:1fr} .g2{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px} }
</style>
</head>
<body>
<header>
  <h1>‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (One File + Auto Sync)</h1>
  <div class="right">
    <button id="btnSync" class="ghost">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</button>
    <div id="syncStatus" class="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: idle</div>
    <button id="btnExport" class="ghost">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
    <label class="pill" style="cursor:pointer;">
      ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ <input id="fileImport" type="file" accept="application/json" style="display:none">
    </label>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="pill" data-tab="dashboard">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    <button class="pill" data-tab="wallets">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</button>
    <button class="pill" data-tab="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="pill" data-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  </div>

  <section id="tab-dashboard" class="grid g3">
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h2>
      <div id="sumIncome" style="font-size:28px;font-weight:700">‡∏ø 0.00</div>
    </div>
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h2>
      <div id="sumExpense" style="font-size:28px;font-weight:700">‡∏ø 0.00</div>
    </div>
    <div class="card">
      <h2>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</h2>
      <div id="sumNet" style="font-size:28px;font-weight:700">‡∏ø 0.00</div>
    </div>

    <div class="card g3" style="grid-column:1/-1">
      <div class="row" style="justify-content:space-between">
        <h2>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <span class="tiny muted">‡∏Ñ‡∏•‡∏¥‡∏Å ‚úèÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / üóë ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö</span>
      </div>
      <div id="walletList" class="grid g3"></div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="row" style="justify-content:space-between">
        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        <span class="tiny muted">‡πÅ‡∏™‡∏î‡∏á 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≤‡∏Å</th><th>‡πÑ‡∏õ</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th><th class="num">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÇ‡∏ô‡πâ‡∏ï</th></tr></thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-wallets" class="grid g2" style="display:none">
    <div class="card">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</h2>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
      <input id="wName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å" />
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="wType">
        <option value="bank">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
        <option value="ewallet">E-Wallet</option>
        <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="crypto">‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï</option>
        <option value="credit">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô)</option>
      </select>
      <div id="wBlkBalance">
        <label>‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
        <input id="wBalance" type="number" placeholder="0" />
      </div>
      <div id="wBlkCredit" style="display:none">
        <label>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</label>
        <input id="wLimit" type="number" placeholder="50000" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnAddWallet" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
        <button id="btnUpdateWallet" class="ghost" disabled>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
        <button id="btnCancelEditWallet" class="ghost" disabled>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>

    <div class="card">
      <h2>‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h2>
      <label>‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
      <select id="payFrom"></select>
      <label>‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label>
      <select id="payCard"></select>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="payAmt" type="number" placeholder="0" />
      <button id="btnPay" class="primary" style="margin-top:8px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </section>

  <section id="tab-add" class="grid g2" style="display:none">
    <div class="card">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input id="tDate" type="date" />
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="tType">
        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        <option value="transfer">‡πÇ‡∏≠‡∏ô/‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</option>
      </select>
      <label id="lblFrom">‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
      <select id="tFrom"></select>
      <div id="blkTo" style="display:none">
        <label>‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£)</label>
        <select id="tTo"></select>
      </div>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="tAmt" type="number" />
      <div id="blkCatPlat">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div class="grow">
            <label>‡∏´‡∏°‡∏ß‡∏î</label>
            <input id="tCat" list="dlCats" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà" />
            <datalist id="dlCats"></datalist>
          </div>
          <span class="tiny link" id="manageCats">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‚Ä¶</span>
        </div>
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div class="grow">
            <label>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô</label>
            <input id="tPlat" list="dlPlats" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà" />
            <datalist id="dlPlats"></datalist>
          </div>
          <span class="tiny link" id="managePlats">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‚Ä¶</span>
        </div>
      </div>
      <label>‡πÇ‡∏ô‡πâ‡∏ï</label>
      <input id="tNote" placeholder="‡πÇ‡∏ô‡πâ‡∏ï (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
      <button id="btnAddTx" class="primary" style="margin-top:8px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>

    <div class="card">
      <h2>‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏õ‡∏£‡∏∞‡∏ñ‡∏°</h2>
      <ol>
        <li>‡πÄ‡∏û‡∏¥‡πà‡∏° <b>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</b> ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å, ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)</li>
        <li>‡∏Å‡∏î‡πÅ‡∏ó‡πá‡∏ö <b>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏î‡∏ß‡πà‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£</li>
        <li>‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ <b>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</b> ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏±‡πâ‡∏ô (‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)</li>
        <li>‡∏ñ‡πâ‡∏≤ <b>‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</b> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö <b>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‚Äù</li>
        <li><b>‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</b>: ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</li>
      </ol>
    </div>
  </section>

  <section id="tab-settings" style="display:none">
    <div class="card">
      <h2>‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö Google Sheets</h2>
      <p class="muted tiny">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ</p>
      <label>GS BASE URL</label>
      <input id="gsUrl" />
      <label>API KEY</label>
      <input id="gsKey" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnSaveSync" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</button>
        <button id="btnClear" class="ghost">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      </div>
    </div>
  </section>
</div>

<!-- Modal generic -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <button id="modalCancel" class="ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="modalOk" class="primary">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>
</div>

<!-- Emoji Picker -->
<div class="modal-backdrop" id="emojiBackdrop">
  <div class="modal">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥</h3>
    <div class="emoji-grid" id="emojiGrid"></div>
    <div class="actions"><button id="emojiClose" class="ghost">‡∏õ‡∏¥‡∏î</button></div>
  </div>
</div>

<script>
// ===== Prefilled (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) =====
const PREFILLED_URL = "https://script.google.com/macros/s/AKfycbzHnFO495JmY8oI_1qoygD6-55pmoZg-eeHzoLUQk0XNlbRKahyRbXmW-AIRLaQbtY1/exec";
const PREFILLED_KEY = "boss_2f8c3a1e9d9b4d7abcf1e9f3d8a4e6c1";

// ===== Utils =====
const fmt = n => (Number(n)||0).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
function pad2(n){ return String(n).padStart(2,'0'); }
function formatDateDMY(dateStr){
  const d = new Date(dateStr); if(isNaN(d)) return '';
  return pad2(d.getDate())+'/'+pad2(d.getMonth()+1)+'/'+d.getFullYear();
}
// Use Bangkok time for timestamps
function nowISO(){
  return new Date().toLocaleString('sv-SE', { timeZone: 'Asia/Bangkok' }).replace(' ', 'T');
}
function todayISO(){ return new Date().toISOString().slice(0,10); }

// Calendar-only input
function enforceDatePickerOnly(inp){
  if(!inp) return;
  inp.setAttribute('inputmode','none');
  inp.setAttribute('readonly','readonly');
  const open = ()=>{ if (typeof inp.showPicker === 'function') { try{ inp.showPicker(); }catch(e){} } };
  inp.addEventListener('focus', open);
  inp.addEventListener('click', open);
}

// ===== Storage =====
const LS_KEY = 'income_expense_onefile_ready_v3_v12';
const load = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)) || null }catch(e){return null} };
const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));

// ===== Default State (‡πÄ‡∏û‡∏¥‡πà‡∏° categories/platforms ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ) =====
const defaultState = () => ({
  cfg: { gsUrl: PREFILLED_URL, gsKey: PREFILLED_KEY },
  wallets: [
    { id: crypto.randomUUID(), name: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å', type: 'bank', balance: 30000, updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï A', type: 'credit', creditLimit: 50000, availableCredit: 50000, updatedAt: nowISO() },
  ],
  categories: [
    { id: crypto.randomUUID(), name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: 'üçú', updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon: 'üíº', updatedAt: nowISO() },
  ],
  platforms: [
    { id: crypto.randomUUID(), name: 'Shopee', icon: 'üõçÔ∏è', updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '7-Eleven', icon: 'üè™', updatedAt: nowISO() },
  ],
  transactions: [],
  ui: { editingWalletId:null }
});

let state = load() || defaultState();
let debounceTimer = null;
let syncStatus = 'idle';
function setSyncStatus(s){ syncStatus = s; document.getElementById('syncStatus').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + s; }

// ===== Google Sheets API (CORS-safe) =====
function withQuery(base, params){
  const url = new URL(base);
  Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') url.searchParams.set(k, String(v)); });
  return url.toString();
}
async function gsFetch(entity, op, payload){
  if(!state.cfg.gsUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ gsUrl');
  if (op === 'list') {
    const url = withQuery(state.cfg.gsUrl, { entity, op, apiKey: state.cfg.gsKey });
    const res = await fetch(url, { method: 'GET' });
    const data = await res.json();
    if (data && data.ok === false) throw new Error(data.error || 'API error');
    return data;
  }
  if (entity === 'bulk' && op === 'replaceAll') {
    const url = withQuery(state.cfg.gsUrl, { entity, op, apiKey: state.cfg.gsKey });
    const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload || {}) });
    const data = await res.json();
    if (data && data.ok === false) throw new Error(data.error || 'API error');
    return data;
  }
  throw new Error('Unknown gsFetch op');
}
async function gsPullAll(){
  const [wallets, transactions, plans] = await Promise.all([
    gsFetch('wallets','list'),
    gsFetch('transactions','list'),
    gsFetch('plans','list'),
  ]);
  return { wallets, transactions, installmentPlans: plans||[] };
}
async function gsPushAll(s){
  const payload = { wallets: s.wallets, transactions: s.transactions, plans: [] };
  return gsFetch('bulk','replaceAll', payload);
}

// ===== Merge helpers =====
function mergeByIdLWW(localArr=[], remoteArr=[]){
  const map = new Map();
  const put = (x)=>{ if(!x?.id) return; const old=map.get(x.id); if(!old){ map.set(x.id,x); return; }
    const ta=Date.parse(old.updatedAt||0)||0, tb=Date.parse(x.updatedAt||0)||0; if(tb>=ta) map.set(x.id,x); };
  localArr.forEach(put); remoteArr.forEach(put);
  return Array.from(map.values());
}
function dedupWalletsByNameType(list=[]){
  const key = w => (w.name||'').trim().toLowerCase()+'|'+(w.type||'');
  const map = new Map();
  for (const w of list){
    const k = key(w);
    if (!map.has(k)) { map.set(k, w); continue; }
    const a = map.get(k);
    const ta = Date.parse(a.updatedAt||0)||0, tb = Date.parse(w.updatedAt||0)||0;
    if (tb > ta) map.set(k, w);
  }
  return Array.from(map.values());
}
function mergeStateLWW(localS, remoteS){
  const merged = {
    ...localS,
    wallets: mergeByIdLWW(localS.wallets, remoteS.wallets),
    transactions: mergeByIdLWW(localS.transactions, remoteS.transactions),
  };
  merged.wallets = dedupWalletsByNameType(merged.wallets);
  return merged;
}

// ===== Emoji Picker (fix: array literal) =====
const COMMON_EMOJIS = [
  "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","üòÇ","üôÇ","üòâ","üòä","üòç","üòò","üòó","üòô","üòö","üòé","ü§©","ü§ó","ü§î","üò¥","ü§§","ü§ì","ü§†","ü•≥",
  "üò∫","üò∏","üòπ","üíº","üí≥","üè¶","üí∞","üëú","üëõ","üèß","üè™","üõí","üõçÔ∏è","üçî","üçú","üç£","üç∫","‚òïÔ∏è","üçµ","üéÅ","üöï","üöó","üöå","üöâ","‚úàÔ∏è",
  "üèùÔ∏è","üè†","üéÆ","üñ•Ô∏è","üì±","‚åöÔ∏è","üßæ","üß∞","üß±","üßΩ","üßª","üßº","üß¥","ü™ô","üí°","üì¶","üìÆ","üìä","üìà","üìâ","üßß","üè∑Ô∏è","üîñ","‚≠êÔ∏è","üî•","üí•","üéØ","üß≠"
];
let _emojiResolve=null;
function openEmojiPicker(){
  const grid = document.getElementById('emojiGrid'); grid.innerHTML='';
  COMMON_EMOJIS.forEach(e=>{
    const btn=document.createElement('button'); btn.className='emoji-btn'; btn.textContent=e;
    btn.addEventListener('click',()=>{ closeEmojiPicker(); if(_emojiResolve) _emojiResolve(e); });
    grid.appendChild(btn);
  });
  document.getElementById('emojiBackdrop').style.display='flex';
  return new Promise(res=>{ _emojiResolve = res; });
}
function closeEmojiPicker(){ document.getElementById('emojiBackdrop').style.display='none'; _emojiResolve=null; }
document.getElementById('emojiClose').addEventListener('click', closeEmojiPicker);

// ===== Modal =====
function openModal(title, el, onOk){
  document.getElementById('modalTitle').textContent = title||'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  const body = document.getElementById('modalBody'); body.innerHTML=''; body.appendChild(el);
  const ok = document.getElementById('modalOk'), cancel = document.getElementById('modalCancel');
  document.getElementById('modalBackdrop').style.display='flex';
  const okH = ()=>{ onOk&&onOk(); document.getElementById('modalBackdrop').style.display='none'; cleanup(); };
  const cancelH = ()=>{ document.getElementById('modalBackdrop').style.display='none'; cleanup(); };
  function cleanup(){ ok.removeEventListener('click', okH); cancel.removeEventListener('click', cancelH); }
  ok.addEventListener('click', okH); cancel.addEventListener('click', cancelH);
}

// ===== Calculations =====
function recalcBalances(s){
  const wallets = s.wallets.map(w=>({...w}));
  wallets.forEach(w=>{
    if(w.type==='credit'){
      if(typeof w.creditLimit!=='number') w.creditLimit=0;
      if(typeof w.availableCredit!=='number') w.availableCredit=w.creditLimit;
    } else {
      if(typeof w.balance!=='number') w.balance = 0;
    }
  });
  const txs = [...s.transactions].sort((a,b)=> new Date(a.date)-new Date(b.date));
  txs.forEach(t=>{
    const from=wallets.find(w=>w.id===t.walletId);
    if(t.type==='income'){
      if(from && from.type!=='credit') from.balance=(from.balance||0)+Math.abs(t.amount);
    }else if(t.type==='expense'){
      if(from){
        if(from.type==='credit') from.availableCredit=Math.max(0,(from.availableCredit||0)-Math.abs(t.amount));
        else from.balance=(from.balance||0)-Math.abs(t.amount);
      }
    }else if(t.type==='transfer'){
      const to=wallets.find(w=>w.id===t.toWalletId);
      const amt=Math.abs(t.amount||0);
      if(from && to){
        if(to.type==='credit'){
          to.availableCredit=Math.min((to.creditLimit||0),(to.availableCredit||0)+amt);
          if(from.type!=='credit') from.balance=(from.balance||0)-amt;
        }else{
          if(from.type==='credit'){ from.availableCredit=Math.max(0,(from.availableCredit||0)-amt); to.balance=(to.balance||0)+amt; }
          else { from.balance=(from.balance||0)-amt; to.balance=(to.balance||0)+amt; }
        }
      }
    }
  });
  return { ...s, wallets };
}

// ===== Render =====
function renderDatalists(){
  const dlCats = document.getElementById('dlCats'); dlCats.innerHTML='';
  state.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; dlCats.appendChild(o); });
  const dlPlats = document.getElementById('dlPlats'); dlPlats.innerHTML='';
  state.platforms.forEach(p=>{ const o=document.createElement('option'); o.value=p.name; dlPlats.appendChild(o); });
}
function render(){
  renderDatalists();
  // month range
  const start = new Date(); start.setDate(1);
  const end = new Date(start.getFullYear(), start.getMonth()+1, 0);
  const inMonth = state.transactions.filter(t=>{ const d=new Date(t.date); d.setHours(0,0,0,0); return d>=start && d<=end; });
  const income = inMonth.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
  const expense = inMonth.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
  document.getElementById('sumIncome').textContent = '‡∏ø '+fmt(income);
  document.getElementById('sumExpense').textContent = '‡∏ø '+fmt(expense);
  const net = income - expense;
  const elNet = document.getElementById('sumNet'); elNet.textContent='‡∏ø '+fmt(net); elNet.className = net>=0 ? 'ok' : 'bad';

  // wallets
  const wl = document.getElementById('walletList'); wl.innerHTML='';
  state.wallets.forEach(w=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:700;margin-bottom:6px">${w.name}</div>
          <div class="muted tiny">‡∏ä‡∏ô‡∏¥‡∏î: ${w.type}</div>
        </div>
        <div class="row">
          <button class="ghost tiny" data-act="edit" data-id="${w.id}">‚úèÔ∏è</button>
          <button class="warn tiny" data-act="del" data-id="${w.id}">üóë</button>
        </div>
      </div>
      ${w.type==='credit' ? `
        <div style="margin-top:6px">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°: ‡∏ø ${fmt(w.creditLimit||0)}</div>
        <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>‡∏ø ${fmt(w.availableCredit||0)}</b></div>`
      : `<div style="margin-top:6px">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>‡∏ø ${fmt(w.balance||0)}</b></div>`}
    `;
    wl.appendChild(div);
  });
  wl.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener('click',()=>startEditWallet(b.dataset.id,true)));
  wl.querySelectorAll('button[data-act="del"]').forEach(b=>b.addEventListener('click',()=>deleteWallet(b.dataset.id)));

  // latest txs
  const body = document.getElementById('txTable'); body.innerHTML='';
  const latest = [...state.transactions].sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,20);
  latest.forEach(t=>{
    const tr=document.createElement('tr');
    const from = state.wallets.find(w=>w.id===t.walletId);
    const to = state.wallets.find(w=>w.id===t.toWalletId);
    tr.innerHTML = `
      <td>${formatDateDMY(t.date)}</td>
      <td>${t.type}</td>
      <td>${from?from.name:'-'}</td>
      <td>${to?to.name:'-'}</td>
      <td>${t.category||'-'}</td>
      <td>${t.platform||'-'}</td>
      <td class="num">${t.type==='expense' ? '-‡∏ø '+fmt(t.amount) : '‡∏ø '+fmt(t.amount)}</td>
      <td>${t.note||''}</td>
    `;
    body.appendChild(tr);
  });

  // selectors
  const selFrom = document.getElementById('tFrom'); selFrom.innerHTML='';
  const selTo = document.getElementById('tTo'); selTo.innerHTML='';
  const payFrom = document.getElementById('payFrom'); payFrom.innerHTML='';
  const payCard = document.getElementById('payCard'); payCard.innerHTML='';
  state.wallets.forEach(w=>{
    const o1=document.createElement('option'); o1.value=w.id; o1.textContent=w.name; selFrom.appendChild(o1.cloneNode(true));
    const o2=document.createElement('option'); o2.value=w.id; o2.textContent=w.name; selTo.appendChild(o2);
    const o3=document.createElement('option'); o3.value=w.id; o3.textContent=w.name; if(w.type!=='credit') payFrom.appendChild(o3);
    const o4=document.createElement('option'); o4.value=w.id; o4.textContent=w.name; if(w.type==='credit') payCard.appendChild(o4);
  });

  document.getElementById('gsUrl').value = state.cfg.gsUrl || '';
  document.getElementById('gsKey').value = state.cfg.gsKey || '';
}

// ===== Mutations + Auto-sync =====
function apply(newState, {skipSync}={}){
  state = recalcBalances(newState);
  save(state);
  render();
  if(!skipSync) scheduleAutoSync();
}
function scheduleAutoSync(){
  if(!state.cfg.gsUrl) return;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(async ()=>{
    try{ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); }
    catch(e){ console.error(e); setSyncStatus('error'); }
  }, 1200);
}

// ===== Wallet CRUD + Dashboard Edit Flow =====
function resetWalletForm(){
  state.ui.editingWalletId = null;
  document.getElementById('wName').value='';
  document.getElementById('wType').value='bank';
  document.getElementById('wBlkBalance').style.display='block';
  document.getElementById('wBlkCredit').style.display='none';
  document.getElementById('wBalance').value='';
  document.getElementById('wLimit').value='';
  document.getElementById('btnAddWallet').disabled=false;
  document.getElementById('btnUpdateWallet').disabled=true;
  document.getElementById('btnCancelEditWallet').disabled=true;
}
function showTab(t){
  document.getElementById('tab-dashboard').style.display = (t==='dashboard')?'grid':'none';
  document.getElementById('tab-wallets').style.display   = (t==='wallets')?'grid':'none';
  document.getElementById('tab-add').style.display       = (t==='add')?'grid':'none';
  document.getElementById('tab-settings').style.display  = (t==='settings')?'block':'none';
}
function startEditWallet(id, fromDashboard=false){
  const w = state.wallets.find(x=>x.id===id); if(!w) return;
  if(fromDashboard) showTab('wallets');
  state.ui.editingWalletId = id;
  document.getElementById('wName').value=w.name||'';
  document.getElementById('wType').value=w.type||'bank';
  if(w.type==='credit'){
    document.getElementById('wBlkBalance').style.display='none';
    document.getElementById('wBlkCredit').style.display='block';
    document.getElementById('wLimit').value=w.creditLimit||0;
  }else{
    document.getElementById('wBlkBalance').style.display='block';
    document.getElementById('wBlkCredit').style.display='none';
    document.getElementById('wBalance').value=w.balance||0;
  }
  document.getElementById('btnAddWallet').disabled=true;
  document.getElementById('btnUpdateWallet').disabled=false;
  document.getElementById('btnCancelEditWallet').disabled=false;
  setTimeout(()=>{ document.getElementById('wName').focus(); },0);
}
function deleteWallet(id){
  const w = state.wallets.find(x=>x.id===id); if(!w) return;
  if(!confirm(`‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ "${w.name}" ?`)) return;
  apply({ ...state, wallets: state.wallets.filter(x=>x.id!==id) });
}
document.getElementById('wType').addEventListener('change', e=>{
  const v=e.target.value;
  document.getElementById('wBlkBalance').style.display = (v==='credit')?'none':'block';
  document.getElementById('wBlkCredit').style.display  = (v==='credit')?'block':'none';
});
document.getElementById('btnAddWallet').addEventListener('click', ()=>{
  const name = document.getElementById('wName').value.trim();
  const type = document.getElementById('wType').value;
  const balance = Number(document.getElementById('wBalance').value||0);
  const limit = Number(document.getElementById('wLimit').value||0);
  if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤');
  let wallet = { id: crypto.randomUUID(), name, type, updatedAt: nowISO() };
  if(type==='credit'){ wallet.creditLimit = limit; wallet.availableCredit = limit; }
  else { wallet.balance = balance; }
  apply({ ...state, wallets: [...state.wallets, wallet] });
  resetWalletForm();
});
document.getElementById('btnUpdateWallet').addEventListener('click', ()=>{
  const id = state.ui.editingWalletId; if(!id) return;
  const name = document.getElementById('wName').value.trim();
  const type = document.getElementById('wType').value;
  const balance = Number(document.getElementById('wBalance').value||0);
  const limit = Number(document.getElementById('wLimit').value||0);
  let wallets = state.wallets.map(w=>{
    if(w.id!==id) return w;
    let nw = {...w, name, type, updatedAt: nowISO() };
    if(type==='credit'){ nw.creditLimit = limit; nw.availableCredit = Math.min(nw.availableCredit||limit, limit); delete nw.balance; }
    else { nw.balance = balance; delete nw.creditLimit; delete nw.availableCredit; }
    return nw;
  });
  apply({ ...state, wallets });
  resetWalletForm();
});
document.getElementById('btnCancelEditWallet').addEventListener('click', resetWalletForm);

// ===== Credit payment =====
document.getElementById('btnPay').addEventListener('click', ()=>{
  const from = document.getElementById('payFrom').value;
  const card = document.getElementById('payCard').value;
  const amt = Number(document.getElementById('payAmt').value||0);
  if(!from || !card || !amt) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const tx = { id: crypto.randomUUID(), date: todayISO(), type:'transfer', walletId: from, toWalletId: card, amount: amt, note: '‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', updatedAt: nowISO() };
  apply({ ...state, transactions: [...state.transactions, tx] });
  document.getElementById('payAmt').value='';
});

// ===== Category/Platform quick manager (modal, same edit UX) =====
function manageSimpleList(kind){
  const isCat = kind==='cat';
  const list = isCat ? state.categories : state.platforms;
  const el = document.createElement('div'); el.className='stack';
  el.innerHTML = `
    <div class="row" style="gap:8px">
      <div class="avatar" id="mIconPrev">${isCat?'üè∑Ô∏è':'üõçÔ∏è'}</div>
      <button class="ghost tiny" id="mPickEmoji">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥</button>
    </div>
    <label>‡∏ä‡∏∑‡πà‡∏≠${isCat?'‡∏´‡∏°‡∏ß‡∏î':'‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô'}</label>
    <input id="mName" placeholder="${isCat?'‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô':'Shopee / ‡∏£‡πâ‡∏≤‡∏ô A'}" />
    <div class="row" style="margin-top:8px">
      <button id="mAdd" class="primary tiny">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button id="mUpdate" class="ghost tiny" disabled>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
      <button id="mCancel" class="ghost tiny" disabled>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div style="margin:10px 0;border-top:1px solid var(--line)"></div>
    <div id="mList"></div>
  `;
  let editingId=null;
  function redraw(){
    const box = el.querySelector('#mList'); box.innerHTML='';
    list.forEach(it=>{
      const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.alignItems='center';
      row.innerHTML = `
        <div class="row" style="gap:8px">
          <div class="avatar">${it.icon||'üè∑Ô∏è'}</div>
          <div>${it.name}</div>
        </div>
        <div class="row">
          <button class="ghost tiny" data-act="e" data-id="${it.id}">‚úèÔ∏è</button>
          <button class="warn tiny" data-act="d" data-id="${it.id}">üóë</button>
        </div>
      `;
      box.appendChild(row);
    });
    renderDatalists();
  }
  redraw();
  el.querySelector('#mPickEmoji').addEventListener('click', async ()=>{
    const em = await openEmojiPicker(); el.querySelector('#mIconPrev').textContent = em;
  });
  el.addEventListener('click', (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    if(btn.id==='mAdd'){
      const name = el.querySelector('#mName').value.trim(); if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠');
      const iconEl = el.querySelector('#mIconPrev'); const icon = iconEl.textContent || (isCat?'üè∑Ô∏è':'üõçÔ∏è');
      const item = { id: crypto.randomUUID(), name, icon, updatedAt: nowISO() };
      if(isCat) state.categories=[...state.categories,item]; else state.platforms=[...state.platforms,item];
      apply(state, {skipSync:true}); el.querySelector('#mName').value=''; el.querySelector('#mIconPrev').textContent = isCat?'üè∑Ô∏è':'üõçÔ∏è'; redraw();
    }else if(btn.dataset.act==='e'){
      const id=btn.dataset.id; const it=list.find(x=>x.id===id); if(!it) return;
      editingId=id; el.querySelector('#mName').value=it.name; el.querySelector('#mIconPrev').textContent=it.icon|| (isCat?'üè∑Ô∏è':'üõçÔ∏è');
      el.querySelector('#mAdd').disabled=true; el.querySelector('#mUpdate').disabled=false; el.querySelector('#mCancel').disabled=false;
    }else if(btn.id==='mUpdate'){
      if(!editingId) return;
      const name = el.querySelector('#mName').value.trim(); if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠');
      const iconEl = el.querySelector('#mIconPrev'); const icon = iconEl.textContent || (isCat?'üè∑Ô∏è':'üõçÔ∏è');
      const arr = list.map(x=> x.id===editingId ? {...x,name,icon,updatedAt:nowISO()} : x);
      if(isCat) state.categories=arr; else state.platforms=arr;
      apply(state, {skipSync:true}); editingId=null; el.querySelector('#mName').value=''; el.querySelector('#mIconPrev').textContent = isCat?'üè∑Ô∏è':'üõçÔ∏è';
      el.querySelector('#mAdd').disabled=false; el.querySelector('#mUpdate').disabled=true; el.querySelector('#mCancel').disabled=true; redraw();
    }else if(btn.id==='mCancel'){
      editingId=null; el.querySelector('#mName').value=''; el.querySelector('#mIconPrev').textContent = isCat?'üè∑Ô∏è':'üõçÔ∏è';
      el.querySelector('#mAdd').disabled=false; el.querySelector('#mUpdate').disabled=true; el.querySelector('#mCancel').disabled=true;
    }else if(btn.dataset.act==='d'){
      const id=btn.dataset.id; const it=list.find(x=>x.id===id); if(!it) return; if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
      const arr = list.filter(x=>x.id!==id); if(isCat) state.categories=arr; else state.platforms=arr;
      apply(state, {skipSync:true}); redraw();
    }
  });
  openModal(isCat?'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î':'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°', el, ()=>{});
}

// ===== Render boot =====
function renderOnBoot(){
  render();
  // init date inputs
  document.getElementById('tDate').value = todayISO();
  // enforce popup calendar
  ['tDate'].forEach(id=> enforceDatePickerOnly(document.getElementById(id)));
}

// ===== Tabs =====
document.querySelectorAll('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{
  showTab(btn.dataset.tab);
}));

// ===== Type & Add TX =====
document.getElementById('tType').addEventListener('change', e=>{
  const v=e.target.value;
  document.getElementById('blkTo').style.display = (v==='transfer')?'block':'none';
  document.getElementById('lblFrom').textContent = (v==='income')?'‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤':'‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤';
  document.getElementById('blkCatPlat').style.display = (v==='transfer')?'none':'block';
});
document.getElementById('btnAddTx').addEventListener('click', ()=>{
  const date = document.getElementById('tDate').value || todayISO();
  const type = document.getElementById('tType').value;
  const walletId = document.getElementById('tFrom').value;
  const toWalletId = document.getElementById('tTo').value || undefined;
  const amount = Number(document.getElementById('tAmt').value||0);
  const category = document.getElementById('tCat').value.trim();
  const platform = document.getElementById('tPlat').value.trim();
  const note = document.getElementById('tNote').value.trim();
  if(!walletId || !amount) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
  const tx = { id: crypto.randomUUID(), date, type, walletId, toWalletId, amount, category, platform, note, updatedAt: nowISO() };
  apply({ ...state, transactions: [...state.transactions, tx] });
  document.getElementById('tAmt').value=''; document.getElementById('tCat').value=''; document.getElementById('tPlat').value=''; document.getElementById('tNote').value='';
});

// ===== Manage cats/plats links =====
document.getElementById('manageCats').addEventListener('click', ()=> manageSimpleList('cat'));
document.getElementById('managePlats').addEventListener('click', ()=> manageSimpleList('plat'));

// ===== Settings & Sync =====
document.getElementById('btnSaveSync').addEventListener('click', async ()=>{
  state.cfg.gsUrl = document.getElementById('gsUrl').value.trim();
  state.cfg.gsKey = document.getElementById('gsKey').value.trim();
  save(state);
  if(!state.cfg.gsUrl) return alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL)');
  try{
    setSyncStatus('pulling');
    const remote = await gsPullAll();
    const isEmpty = (remote.wallets?.length||0)+(remote.transactions?.length||0)===0;
    if(isEmpty){ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à & ‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï'); }
    else { const merged = mergeStateLWW(state, remote); apply(merged, {skipSync:true}); setSyncStatus('idle'); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à & ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); }
  }catch(e){ console.error(e); setSyncStatus('error'); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à URL/Key'); }
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?')){ localStorage.removeItem(LS_KEY); state = defaultState(); apply(state, {skipSync:true}); }
});
document.getElementById('btnSync').addEventListener('click', async ()=>{
  if(!state.cfg.gsUrl) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
  try{ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); alert('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß'); }
  catch(e){ console.error(e); setSyncStatus('error'); alert('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); }
});
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'income-expense-backup.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('fileImport').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = () => { try{ const s = JSON.parse(rd.result); apply(s, {skipSync:true}); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'); }catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } };
  rd.readAsText(f);
});

// ===== Boot (pull ‚Üí merge ‚Üí render) =====
async function boot(){
  renderOnBoot();
  if(state.cfg.gsUrl){
    try{
      setSyncStatus('pulling');
      const remote = await gsPullAll();
      const isEmpty = (remote.wallets?.length||0) + (remote.transactions?.length||0) === 0;
      const localLooksSeed =
        (state.wallets?.length === 2 && state.transactions?.length === 0) &&
        state.wallets.some(w => w.name === '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å') &&
        state.wallets.some(w => w.name === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï A');
      if (!isEmpty && localLooksSeed) {
        state = recalcBalances({ ...state, wallets: remote.wallets, transactions: remote.transactions });
        save(state); render(); setSyncStatus('idle'); return;
      }
      if(isEmpty){ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); }
      else { const merged = mergeStateLWW(state, remote); apply(merged, {skipSync:true}); setSyncStatus('idle'); }
    }catch(e){ console.error(e); setSyncStatus('error'); }
  }
}
boot();
</script>
</body>
</html>
