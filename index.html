<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Money Tracker</title>
<style>
  :root { --bg:#0b0b0f; --card:#14141a; --muted:#8b8b94; --text:#eaeaf1; --accent:#5ee391; --danger:#ff6b6b; --line:#23232a; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{padding:16px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid #222;position:sticky;top:0;background:rgba(11,11,15,.85);backdrop-filter:saturate(120%) blur(6px);z-index:50}
  h1{font-size:20px;margin:0}
  .right{display:flex;gap:8px;align-items:center}
  button, select, input{font:inherit}
  button{padding:8px 12px;border-radius:12px;border:1px solid #333;background:#1d1d25;color:var(--text);cursor:pointer}
  button.primary{background:#1c2a21;border-color:#284130}
  button.ghost{background:transparent;border-color:#333}
  button.warn{background:#2a1414;border-color:#402828;color:#ffb3b3}
  button:disabled{opacity:.6;cursor:not-allowed}
  .status{font-size:12px;color:var(--muted)}
  .wrap{padding:16px;max-width:1200px;margin:0 auto}
  .tabs{display:flex;gap:8px;margin:12px 0 16px;flex-wrap:wrap}
  .tabs button{border-radius:999px;padding:8px 14px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card h2{margin:0 0 10px 0;font-size:16px}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
  input, select, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a33;background:#111018;color:var(--text)}
  textarea{min-height:80px;resize:vertical}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  td.num{text-align:right}
  .ok{color:var(--accent)} .bad{color:var(--danger)}
  .muted{color:var(--muted)}
  .pill{display:inline-block;border:1px solid #333;border-radius:999px;padding:6px 12px;font-size:13px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grow{flex:1 1 auto}
  .avatar{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#1b1b22;border:1px solid #2b2b33;font-size:16px}
  .avatar img{width:100%;height:100%;object-fit:cover;border-radius:8px;display:block}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border:1px solid #333;padding:4px 8px;border-radius:999px;font-size:12px}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0}
  .badge{font-size:11px;border:1px solid #333;padding:2px 6px;border-radius:999px;color:var(--muted)}
  .bar{height:8px;background:#0e0e14;border:1px solid #1f1f26;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#52d384,#5ee391);}
  .help{font-size:12px;color:var(--muted)}
  .danger{color:var(--danger)}
  .center{display:grid;place-items:center}
  .stack{display:flex;flex-direction:column;gap:8px}
  .nowrap{white-space:nowrap}
  .tac{text-align:center}
  .table-wrap{overflow:auto}
  .link{color:#9ad7ff;text-decoration:underline;cursor:pointer}
  .sep{height:1px;background:var(--line);margin:8px 0}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .modal{width:min(560px,100%);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .modal h3{margin:0 0 8px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  /* Emoji picker */
  .emoji-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:8px;background:#0f0f15}
  .emoji-btn{font-size:18px;background:#15151c;border:1px solid #2a2a33;border-radius:10px;cursor:pointer;padding:6px}
  .emoji-btn:hover{transform:translateY(-1px)}
  /* Responsive */
  @media (max-width:1100px){ .g4{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:900px){ .g3{grid-template-columns:1fr} .g2{grid-template-columns:1fr} .g4{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px} }
</style>
</head>
<body>
<header>
  <h1>‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Feature Expansion v1)</h1>
  <div class="right">
    <div class="row">
      <span class="badge">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
      <select id="dashRange" class="pill">
        <option value="thisMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
        <option value="lastMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
        <option value="thisYear">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‚Ä¶</option>
      </select>
      <input id="dashFrom" type="date" style="display:none">
      <span style="display:none">‚Äì</span>
      <input id="dashTo" type="date" style="display:none">
    </div>
    <button id="btnSync" class="ghost">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</button>
    <div id="syncStatus" class="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: idle</div>
    <button id="btnExport" class="ghost">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
    <label class="pill" style="cursor:pointer;">
      ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ <input id="fileImport" type="file" accept="application/json" style="display:none">
    </label>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="pill" data-tab="dashboard">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    <button class="pill" data-tab="wallets">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</button>
    <button class="pill" data-tab="transactions">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="pill" data-tab="categories">‡∏´‡∏°‡∏ß‡∏î</button>
    <button class="pill" data-tab="platforms">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô</button>
    <button class="pill" data-tab="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="pill" data-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  </div>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="grid g3">
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h2>
      <div id="sumIncome" style="font-size:28px;font-weight:700">‡∏ø 0.00</div>
    </div>
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h2>
      <div id="sumExpense" style="font-size:28px;font-weight:700">‡∏ø 0.00</div>
    </div>
    <div class="card">
      <h2>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</h2>
      <div id="sumNet" style="font-size:28px;font-weight:700">‡∏ø 0.00</div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="toolbar">
        <h2>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <span class="help">‡∏Ñ‡∏•‡∏¥‡∏Å ‚úèÔ∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / üóë ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö</span>
      </div>
      <div id="walletList" class="grid g4"></div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="toolbar">
        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)</h2>
        <span class="help">‡πÅ‡∏™‡∏î‡∏á 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≤‡∏Å</th><th>‡πÑ‡∏õ</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th><th class="num">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÇ‡∏ô‡πâ‡∏ï</th></tr></thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- WALLETS -->
  <section id="tab-wallets" class="grid g2" style="display:none">
    <div class="card">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</h2>
      <div class="row">
        <div class="avatar" id="wIconPreview">üíº</div>
        <button class="ghost" id="btnPickWalletEmoji">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</button>
      </div>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
      <input id="wName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å" />
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="wType">
        <option value="bank">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
        <option value="ewallet">E-Wallet</option>
        <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="crypto">‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï</option>
        <option value="credit">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô)</option>
      </select>
      <div id="wBlkBalance">
        <label>‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
        <input id="wBalance" type="number" placeholder="0" />
      </div>
      <div id="wBlkCredit" style="display:none">
        <label>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</label>
        <input id="wLimit" type="number" placeholder="50000" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnAddWallet" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
        <button id="btnUpdateWallet" class="ghost" disabled>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</button>
        <button id="btnCancelEditWallet" class="ghost" disabled>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
      <div class="help">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á ‚Äú‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‚Äù ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
    </div>

    <div class="card">
      <h2>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h2>
      <label>‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
      <select id="payFrom"></select>
      <label>‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label>
      <select id="payCard"></select>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="payAmt" type="number" placeholder="0" />
      <button id="btnPay" class="primary" style="margin-top:8px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

      <div class="sep"></div>
      <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‚Äú‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‚Äù</h2>
      <label>‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£ (‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)</label>
      <select id="instWallet"></select>
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÇ‡∏ô‡πâ‡∏ï)</label>
      <input id="instDesc" placeholder="‡∏ú‡πà‡∏≠‡∏ô iPhone 12" />
      <div class="row">
        <div class="grow">
          <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</label>
          <input id="instTotal" type="number" placeholder="12000" />
        </div>
        <div class="grow">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="instMonths" type="number" placeholder="6" />
        </div>
      </div>
      <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏î‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</label>
      <input id="instStart" type="date" />
      <button id="btnCreatePlan" class="primary" style="margin-top:8px">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô</button>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="toolbar">
        <h2>‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</h2>
        <span class="help">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏ß‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏¢‡∏≠‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="planTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- TRANSACTIONS -->
  <section id="tab-transactions" style="display:none">
    <div class="card">
      <div class="toolbar">
        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div class="row">
          <select id="txFilterField">
            <option value="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD)</option>
            <option value="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (income/expense/transfer)</option>
            <option value="wallet">‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</option>
            <option value="to">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</option>
            <option value="category">‡∏´‡∏°‡∏ß‡∏î</option>
            <option value="platform">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</option>
            <option value="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</option>
            <option value="note">‡πÇ‡∏ô‡πâ‡∏ï</option>
          </select>
          <input id="txFilterQuery" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‚Ä¶" />
          <button id="btnClearFilter" class="ghost">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≤‡∏Å</th><th>‡πÑ‡∏õ</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th><th class="num">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÇ‡∏ô‡πâ‡∏ï</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="txAllTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CATEGORIES -->
  <section id="tab-categories" class="grid g2" style="display:none">
    <div class="card">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</h2>
      <div class="row">
        <div class="avatar" id="catIconPreview">üè∑Ô∏è</div>
        <button class="ghost" id="btnPickCatEmoji">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</button>
      </div>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î</label>
      <input id="catName" placeholder="‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" />
      <div class="row" style="margin-top:8px">
        <button id="btnAddCat" class="primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
        <button id="btnUpdateCat" class="ghost" disabled>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î</button>
        <button id="btnCancelEditCat" class="ghost" disabled>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <div class="card">
      <h2>‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      <div id="catList" class="grid g4"></div>
    </div>
  </section>

  <!-- PLATFORMS -->
  <section id="tab-platforms" class="grid g2" style="display:none">
    <div class="card">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô</h2>
      <div class="row">
        <div class="avatar" id="platIconPreview">üõçÔ∏è</div>
        <button class="ghost" id="btnPickPlatEmoji">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</button>
        <input id="platIconFile" type="file" accept="image/*" class="ghost" />
      </div>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô</label>
      <input id="platName" placeholder="Shopee / ‡∏£‡πâ‡∏≤‡∏ô A ‡∏™‡∏≤‡∏Ç‡∏≤ B" />
      <div class="row" style="margin-top:8px">
        <button id="btnAddPlat" class="primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        <button id="btnUpdatePlat" class="ghost" disabled>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
        <button id="btnCancelEditPlat" class="ghost" disabled>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <div class="card">
      <h2>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      <div id="platList" class="grid g4"></div>
    </div>
  </section>

  <!-- ADD TRANSACTION -->
  <section id="tab-add" class="grid g2" style="display:none">
    <div class="card">
      <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input id="tDate" type="date" />
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="tType">
        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        <option value="transfer">‡πÇ‡∏≠‡∏ô/‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</option>
      </select>
      <label id="lblFrom">‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
      <select id="tFrom"></select>
      <div id="blkTo" style="display:none">
        <label>‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£)</label>
        <select id="tTo"></select>
      </div>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="tAmt" type="number" />
      <div id="blkCatPlat">
        <label>‡∏´‡∏°‡∏ß‡∏î</label>
        <input id="tCat" list="dlCats" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà" />
        <datalist id="dlCats"></datalist>
        <label>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô</label>
        <input id="tPlat" list="dlPlats" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà" />
        <datalist id="dlPlats"></datalist>
      </div>
      <label>‡πÇ‡∏ô‡πâ‡∏ï</label>
      <input id="tNote" placeholder="‡πÇ‡∏ô‡πâ‡∏ï (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
      <button id="btnAddTx" class="primary" style="margin-top:8px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>

    <div class="card">
      <h2>‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏õ‡∏£‡∏∞‡∏ñ‡∏°</h2>
      <ol>
        <li>‡πÄ‡∏û‡∏¥‡πà‡∏° <b>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</b> ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å, ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)</li>
        <li>‡∏Å‡∏î‡πÅ‡∏ó‡πá‡∏ö <b>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏î‡∏ß‡πà‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£</li>
        <li>‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ <b>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</b> ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏±‡πâ‡∏ô (‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)</li>
        <li>‡∏ñ‡πâ‡∏≤ <b>‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</b> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö <b>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‚Äù</li>
        <li><b>‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô</b> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</li>
        <li><b>‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</b>: ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</li>
      </ol>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" style="display:none">
    <div class="card">
      <h2>‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö Google Sheets</h2>
      <p class="muted">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ</p>
      <label>GS BASE URL</label>
      <input id="gsUrl" />
      <label>API KEY</label>
      <input id="gsKey" />
      <div class="row" style="margin-top:8px">
        <button id="btnSaveSync" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</button>
        <button id="btnClear" class="ghost">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      </div>
    </div>
  </section>
</div>

<!-- Modal (generic) -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3>
    <div id="modalBody" class="stack"></div>
    <div class="actions">
      <button id="modalCancel" class="ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="modalOk" class="primary">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>
</div>

<!-- Emoji Picker Modal -->
<div class="modal-backdrop" id="emojiBackdrop">
  <div class="modal">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥</h3>
    <div class="emoji-grid" id="emojiGrid"></div>
    <div class="actions">
      <button id="emojiClose" class="ghost">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<script>
/* -------------------- Prefilled (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°) -------------------- */
const PREFILLED_URL = "https://script.google.com/macros/s/AKfycbzHnFO495JmY8oI_1qoygD6-55pmoZg-eeHzoLUQk0XNlbRKahyRbXmW-AIRLaQbtY1/exec";
const PREFILLED_KEY = "boss_2f8c3a1e9d9b4d7abcf1e9f3d8a4e6c1";

/* -------------------- Utils -------------------- */
const fmt = n => (Number(n)||0).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
const todayStr = () => new Date().toISOString().slice(0,10);
const nowISO = () => new Date().toISOString();
const firstDayThisMonth = () => { const d=new Date(); d.setDate(1); return d; };
const lastDayThisMonth = () => new Date(new Date().getFullYear(), new Date().getMonth()+1, 0);

/* -------------------- Storage -------------------- */
const LS_KEY = 'income_expense_onefile_ready_v4_featureexp';
const load = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)) || null }catch(e){return null} };
const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));

/* -------------------- Default State -------------------- */
const defaultState = () => ({
  cfg: { gsUrl: PREFILLED_URL, gsKey: PREFILLED_KEY },
  wallets: [
    { id: crypto.randomUUID(), name: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å', type: 'bank', icon:'üíº', balance: 30000, updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï A', type: 'credit', icon:'üí≥', creditLimit: 50000, availableCredit: 50000, updatedAt: nowISO() },
  ],
  categories: [
    { id: crypto.randomUUID(), name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: 'üçú', updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', icon: 'üöå', updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon: 'üíº', updatedAt: nowISO() },
  ],
  platforms: [
    { id: crypto.randomUUID(), name: 'Shopee', icon: 'üõçÔ∏è', updatedAt: nowISO() },
    { id: crypto.randomUUID(), name: '7-Eleven', icon: 'üè™', updatedAt: nowISO() },
  ],
  transactions: [],
  installmentPlans: [], // kept in sync with Google Sheet 'plans' entity
  ui: { editingWalletId: null, editingCatId:null, editingPlatId:null, editingTxId:null, dash:{mode:'thisMonth', from:null, to:null} }
});

let state = load() || defaultState();
let debounceTimer = null;
let syncStatus = 'idle';
function setSyncStatus(s){ syncStatus = s; document.getElementById('syncStatus').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + s; }

/* -------------------- Google Sheets API (CORS-safe, compatible) -------------------- */
function withQuery(base, params){
  const url = new URL(base);
  Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') url.searchParams.set(k, String(v)); });
  return url.toString();
}
async function gsFetch(entity, op, payload){
  if(!state.cfg.gsUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ gsUrl');
  if (op === 'list') {
    const url = withQuery(state.cfg.gsUrl, { entity, op, apiKey: state.cfg.gsKey });
    const res = await fetch(url, { method: 'GET' });
    const data = await res.json();
    if (data && data.ok === false) throw new Error(data.error || 'API error');
    return data;
  }
  if (entity === 'bulk' && op === 'replaceAll') {
    const url = withQuery(state.cfg.gsUrl, { entity, op, apiKey: state.cfg.gsKey });
    const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload || {}) });
    const data = await res.json();
    if (data && data.ok === false) throw new Error(data.error || 'API error');
    return data;
  }
  throw new Error('Unknown gsFetch op');
}
async function gsPullAll(){
  const [wallets, transactions, plans] = await Promise.all([
    gsFetch('wallets','list'),
    gsFetch('transactions','list'),
    gsFetch('plans','list'),
  ]);
  return { wallets, transactions, installmentPlans: plans||[] };
}
async function gsPushAll(s){
  // push categories/platforms only locally (to avoid breaking remote script). Push plans as 'plans'.
  const payload = { wallets: s.wallets, transactions: s.transactions, plans: s.installmentPlans || [] };
  return gsFetch('bulk','replaceAll', payload);
}

/* -------------------- Merge helpers -------------------- */
function mergeByIdLWW(localArr=[], remoteArr=[]){
  const map = new Map();
  const put = (x)=>{ if(!x?.id) return; const old=map.get(x.id); if(!old){ map.set(x.id,x); return; }
    const ta=Date.parse(old.updatedAt||0)||0, tb=Date.parse(x.updatedAt||0)||0; if(tb>=ta) map.set(x.id,x); };
  localArr.forEach(put); remoteArr.forEach(put);
  return Array.from(map.values());
}
function dedupWalletsByNameType(list=[]){
  const key = w => (w.name||'').trim().toLowerCase()+'|'+(w.type||'');
  const map = new Map();
  for (const w of list){
    const k = key(w);
    if (!map.has(k)) { map.set(k, w); continue; }
    const a = map.get(k);
    const ta = Date.parse(a.updatedAt||0)||0, tb = Date.parse(w.updatedAt||0)||0;
    if (tb > ta) map.set(k, w);
  }
  return Array.from(map.values());
}
function mergeStateLWW(localS, remoteS){
  const merged = {
    ...localS,
    wallets: mergeByIdLWW(localS.wallets, remoteS.wallets),
    transactions: mergeByIdLWW(localS.transactions, remoteS.transactions),
    installmentPlans: mergeByIdLWW(localS.installmentPlans||[], remoteS.installmentPlans||[]),
  };
  merged.wallets = dedupWalletsByNameType(merged.wallets);
  return merged;
}

/* -------------------- Calculations -------------------- */
function recalcBalances(s){
  const wallets = s.wallets.map(w=>({...w}));
  wallets.forEach(w=>{
    if(w.type==='credit'){
      if(typeof w.creditLimit!=='number') w.creditLimit=0;
      if(typeof w.availableCredit!=='number') w.availableCredit=w.creditLimit;
    } else {
      if(typeof w.balance!=='number') w.balance = 0;
    }
  });
  const txs = [...s.transactions].sort((a,b)=> new Date(a.date)-new Date(b.date));
  txs.forEach(t=>{
    const from=wallets.find(w=>w.id===t.walletId);
    if(t.type==='income'){
      if(from && from.type!=='credit') from.balance=(from.balance||0)+Math.abs(t.amount);
    }else if(t.type==='expense'){
      if(from){
        if(from.type==='credit') from.availableCredit=Math.max(0,(from.availableCredit||0)-Math.abs(t.amount));
        else from.balance=(from.balance||0)-Math.abs(t.amount);
      }
    }else if(t.type==='transfer'){
      const to=wallets.find(w=>w.id===t.toWalletId);
      const amt=Math.abs(t.amount||0);
      if(from && to){
        if(to.type==='credit'){
          to.availableCredit=Math.min((to.creditLimit||0),(to.availableCredit||0)+amt);
          if(from.type!=='credit') from.balance=(from.balance||0)-amt;
        }else{
          if(from.type==='credit'){ from.availableCredit=Math.max(0,(from.availableCredit||0)-amt); to.balance=(to.balance||0)+amt; }
          else { from.balance=(from.balance||0)-amt; to.balance=(to.balance||0)+amt; }
        }
      }
    }
  });
  return { ...s, wallets };
}

/* -------------------- Timeframe helpers -------------------- */
function getRange(){
  const mode = state.ui?.dash?.mode || 'thisMonth';
  let from, to;
  if(mode==='thisMonth'){ from = firstDayThisMonth(); to = lastDayThisMonth(); }
  else if(mode==='lastMonth'){ const d=new Date(); const first=new Date(d.getFullYear(), d.getMonth()-1, 1); const last=new Date(d.getFullYear(), d.getMonth(), 0); from=first; to=last; }
  else if(mode==='thisYear'){ const d=new Date(); from=new Date(d.getFullYear(),0,1); to=new Date(d.getFullYear(),11,31); }
  else if(mode==='custom'){ from = new Date(state.ui?.dash?.from || todayStr()); to = new Date(state.ui?.dash?.to || todayStr()); }
  return {from,to};
}
function inRange(dateStr){
  const {from,to} = getRange();
  const d = new Date(dateStr);
  d.setHours(0,0,0,0);
  return d>=from && d<=to;
}

/* -------------------- Render -------------------- */
function renderDatalists(){
  const dlCats = document.getElementById('dlCats'); dlCats.innerHTML='';
  state.categories.forEach(c=>{
    const opt = document.createElement('option'); opt.value=c.name; dlCats.appendChild(opt);
  });
  const dlPlats = document.getElementById('dlPlats'); dlPlats.innerHTML='';
  state.platforms.forEach(p=>{
    const opt = document.createElement('option'); opt.value=p.name; dlPlats.appendChild(opt);
  });
}
function iconHtml(icon){
  // icon: emoji string or dataURL image
  if(!icon) return '<div class="avatar">üì¶</div>';
  if(String(icon).startsWith('data:image')) return `<div class="avatar"><img src="${icon}" alt=""></div>`;
  return `<div class="avatar">${icon}</div>`;
}
function renderDashboard(){
  const txInRange = state.transactions.filter(t=>inRange(t.date));
  const income = txInRange.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
  const expense = txInRange.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
  document.getElementById('sumIncome').textContent = '‡∏ø '+fmt(income);
  document.getElementById('sumExpense').textContent = '‡∏ø '+fmt(expense);
  const net = income - expense;
  const elNet = document.getElementById('sumNet'); elNet.textContent='‡∏ø '+fmt(net); elNet.className = net>=0 ? 'ok' : 'bad';

  const wl = document.getElementById('walletList'); wl.innerHTML='';
  state.wallets.forEach(w=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="row" style="gap:10px">
          ${iconHtml(w.icon)}
          <div>
            <div style="font-weight:700;margin-bottom:4px">${w.name}</div>
            <div class="muted">‡∏ä‡∏ô‡∏¥‡∏î: ${w.type}</div>
          </div>
        </div>
        <div class="row">
          <button class="ghost" data-act="edit" data-id="${w.id}">‚úèÔ∏è</button>
          <button class="warn" data-act="del" data-id="${w.id}">üóë</button>
        </div>
      </div>
      <div style="margin-top:8px">
        ${w.type==='credit'
          ? `<div>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°: ‡∏ø ${fmt(w.creditLimit||0)}</div>
             <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>‡∏ø ${fmt(w.availableCredit||0)}</b></div>`
          : `<div>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>‡∏ø ${fmt(w.balance||0)}</b></div>`}
      </div>
    `;
    wl.appendChild(div);
  });
  wl.querySelectorAll('button[data-act="edit"]').forEach(btn=>btn.addEventListener('click',()=>startEditWallet(btn.dataset.id)));
  wl.querySelectorAll('button[data-act="del"]').forEach(btn=>btn.addEventListener('click',()=>deleteWallet(btn.dataset.id)));

  const body = document.getElementById('txTable'); body.innerHTML='';
  const latest = txInRange.sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,20);
  latest.forEach(t=>{
    const tr=document.createElement('tr');
    const from = state.wallets.find(w=>w.id===t.walletId);
    const to = state.wallets.find(w=>w.id===t.toWalletId);
    tr.innerHTML = `
      <td>${new Date(t.date).toLocaleDateString('th-TH')}</td>
      <td>${t.type}</td>
      <td>${from?from.name:'(‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)'}</td>
      <td>${to?to.name:'-'}</td>
      <td>${t.category||'-'}</td>
      <td>${t.platform||'-'}</td>
      <td class="num">${t.type==='expense' ? '-‡∏ø '+fmt(t.amount) : '‡∏ø '+fmt(t.amount)}</td>
      <td>${t.note||''}</td>
    `; body.appendChild(tr);
  });
}
function renderWalletSelectors(){
  const selFrom = document.getElementById('tFrom'); selFrom.innerHTML='';
  const selTo = document.getElementById('tTo'); selTo.innerHTML='';
  const payFrom = document.getElementById('payFrom'); payFrom.innerHTML='';
  const payCard = document.getElementById('payCard'); payCard.innerHTML='';
  const instWallet = document.getElementById('instWallet'); instWallet.innerHTML='';
  state.wallets.forEach(w=>{
    const opt=document.createElement('option'); opt.value=w.id; opt.textContent=w.name; selFrom.appendChild(opt.cloneNode(true));
    const opt2=document.createElement('option'); opt2.value=w.id; opt2.textContent=w.name; selTo.appendChild(opt2);
    const opt3=document.createElement('option'); opt3.value=w.id; opt3.textContent=w.name; if(w.type!=='credit') payFrom.appendChild(opt3);
    const opt4=document.createElement('option'); opt4.value=w.id; opt4.textContent=w.name; if(w.type==='credit') { payCard.appendChild(opt4); instWallet.appendChild(opt4.cloneNode(true)); }
  });
}
function renderCategories(){
  const list = document.getElementById('catList'); list.innerHTML='';
  state.categories.forEach(c=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:10px">
          ${iconHtml(c.icon)}
          <div>
            <div style="font-weight:700">${c.name}</div>
          </div>
        </div>
        <div class="row">
          <button class="ghost" data-act="edit" data-id="${c.id}">‚úèÔ∏è</button>
          <button class="warn" data-act="del" data-id="${c.id}">üóë</button>
        </div>
      </div>
    `;
    list.appendChild(card);
  });
  list.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener('click',()=>startEditCategory(b.dataset.id)));
  list.querySelectorAll('button[data-act="del"]').forEach(b=>b.addEventListener('click',()=>deleteCategory(b.dataset.id)));
}
function renderPlatforms(){
  const list = document.getElementById('platList'); list.innerHTML='';
  state.platforms.forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="row" style="gap:10px">
          ${iconHtml(p.icon)}
          <div><div style="font-weight:700">${p.name}</div></div>
        </div>
        <div class="row">
          <button class="ghost" data-act="edit" data-id="${p.id}">‚úèÔ∏è</button>
          <button class="warn" data-act="del" data-id="${p.id}">üóë</button>
        </div>
      </div>
    `;
    list.appendChild(card);
  });
  list.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener('click',()=>startEditPlatform(b.dataset.id)));
  list.querySelectorAll('button[data-act="del"]').forEach(b=>b.addEventListener('click',()=>deletePlatform(b.dataset.id)));
}
function renderPlans(){
  const body = document.getElementById('planTable'); body.innerHTML='';
  state.installmentPlans.filter(p=>p.active!==false).forEach(p=>{
    const w = state.wallets.find(x=>x.id===p.walletId);
    const tr=document.createElement('tr');
    const prog = Math.min(100, Math.round((p.paidCount||0) / (p.months||1) * 100));
    tr.innerHTML = `
      <td>${w? w.name : '(‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)'}</td>
      <td>${p.desc||'-'}</td>
      <td class="num">‡∏ø ${fmt(p.perMonth||0)}</td>
      <td>${p.startDate||'-'}</td>
      <td>
        ${p.paidCount||0} / ${p.months||0}
        <div class="bar" style="margin-top:6px"><span style="width:${prog}%"></span></div>
      </td>
      <td>${p.nextDue || '-'}</td>
      <td>${prog>=100 ? '<span class="ok">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô'}</td>
      <td class="nowrap">
        <button class="ghost" data-act="force" data-id="${p.id}">‡∏´‡∏±‡∏Å‡∏á‡∏ß‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="warn" data-act="cancel" data-id="${p.id}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </td>
    `;
    body.appendChild(tr);
  });
  body.querySelectorAll('button[data-act="force"]').forEach(b=>b.addEventListener('click',()=>postOneInstallment(b.dataset.id,true)));
  body.querySelectorAll('button[data-act="cancel"]').forEach(b=>b.addEventListener('click',()=>cancelPlan(b.dataset.id)));
}
function renderTxTableAll(){
  const body = document.getElementById('txAllTable'); body.innerHTML='';
  const field = document.getElementById('txFilterField').value;
  const q = (document.getElementById('txFilterQuery').value||'').trim().toLowerCase();
  let rows = [...state.transactions];
  if(q){
    rows = rows.filter(t=>{
      const from = state.wallets.find(w=>w.id===t.walletId);
      const to = state.wallets.find(w=>w.id===t.toWalletId);
      const map = {
        date: t.date,
        type: t.type,
        wallet: from?from.name:'',
        to: to?to.name:'',
        category: t.category||'',
        platform: t.platform||'',
        amount: String(t.amount||''),
        note: t.note||'',
      };
      return (map[field]||'').toLowerCase().includes(q);
    });
  }
  rows.sort((a,b)=> new Date(b.date)-new Date(a.date));
  rows.forEach(t=>{
    const tr=document.createElement('tr');
    const from = state.wallets.find(w=>w.id===t.walletId);
    const to = state.wallets.find(w=>w.id===t.toWalletId);
    tr.innerHTML = `
      <td>${t.date}</td>
      <td>${t.type}</td>
      <td>${from?from.name:'(‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß)'}</td>
      <td>${to?to.name:'-'}</td>
      <td>${t.category||'-'}</td>
      <td>${t.platform||'-'}</td>
      <td class="num">${t.type==='expense' ? '-‡∏ø '+fmt(t.amount) : '‡∏ø '+fmt(t.amount)}</td>
      <td>${t.note||''}</td>
      <td class="nowrap">
        <button class="ghost" data-act="edit" data-id="${t.id}">‚úèÔ∏è</button>
        <button class="warn" data-act="del" data-id="${t.id}">üóë</button>
      </td>
    `;
    body.appendChild(tr);
  });
  body.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener('click',()=>editTx(b.dataset.id)));
  body.querySelectorAll('button[data-act="del"]').forEach(b=>b.addEventListener('click',()=>deleteTx(b.dataset.id)));
}
function render(){
  renderDatalists();
  renderDashboard();
  renderWalletSelectors();
  renderCategories();
  renderPlatforms();
  renderPlans();
  renderTxTableAll();
  document.getElementById('gsUrl').value = state.cfg.gsUrl || '';
  document.getElementById('gsKey').value = state.cfg.gsKey || '';
}

/* -------------------- Emoji Picker -------------------- */
const COMMON_EMOJIS = "üòÄüòÉüòÑüòÅüòÜüòÖüòÇüôÇüòâüòäüòçüòòüòóüòôüòöüòéü§©ü§óü§îüò¥ü§§ü§ìü§†ü•≥üò∫üò∏üòπüíºüí≥üè¶üí∞üëúüëõüèßüè™üõíüõçÔ∏èüçîüçúüç£üç∫‚òïÔ∏èüçµüéÅüöïüöóüöåüöâ‚úàÔ∏èüèùÔ∏èüè†üéÆüñ•Ô∏èüì±‚åöÔ∏èüßæüß∞üß±üßΩüßªüßºüß¥ü™ôüí°üì¶üìÆüì¶üìäüìàüìâüßßüè∑Ô∏èüîñ‚≠êÔ∏èüî•üí•üéØüß≠".split('');
let _emojiResolve = null; // promise resolve
function openEmojiPicker(){
  const grid = document.getElementById('emojiGrid'); grid.innerHTML='';
  COMMON_EMOJIS.forEach(e=>{
    const btn=document.createElement('button'); btn.className='emoji-btn'; btn.textContent=e;
    btn.addEventListener('click',()=>{ closeEmojiPicker(); if(_emojiResolve) _emojiResolve(e); });
    grid.appendChild(btn);
  });
  document.getElementById('emojiBackdrop').style.display='flex';
  return new Promise(res=>{ _emojiResolve = res; });
}
function closeEmojiPicker(){ document.getElementById('emojiBackdrop').style.display='none'; _emojiResolve=null; }
document.getElementById('emojiClose').addEventListener('click', closeEmojiPicker);

/* -------------------- Modal (generic) -------------------- */
function openModal(title, bodyEl, onOk){
  document.getElementById('modalTitle').textContent = title || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  const body = document.getElementById('modalBody'); body.innerHTML=''; body.appendChild(bodyEl);
  const ok = document.getElementById('modalOk'), cancel = document.getElementById('modalCancel');
  const close = ()=> document.getElementById('modalBackdrop').style.display='flex' && (document.getElementById('modalBackdrop').style.display='none');
  document.getElementById('modalBackdrop').style.display='flex';
  const okHandler = ()=>{ onOk && onOk(); document.getElementById('modalBackdrop').style.display='none'; cleanup(); };
  const cancelHandler = ()=>{ document.getElementById('modalBackdrop').style.display='none'; cleanup(); };
  function cleanup(){ ok.removeEventListener('click', okHandler); cancel.removeEventListener('click', cancelHandler); }
  ok.addEventListener('click', okHandler); cancel.addEventListener('click', cancelHandler);
}
/* -------------------- Mutations + Auto-sync -------------------- */
function apply(newState, {skipSync}={}){
  state = recalcBalances(newState);
  save(state);
  render();
  if(!skipSync) scheduleAutoSync();
}
function scheduleAutoSync(){
  if(!state.cfg.gsUrl) return;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(async ()=>{
    try{ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); }
    catch(e){ console.error(e); setSyncStatus('error'); }
  }, 1200);
}

/* -------------------- Wallet CRUD -------------------- */
function resetWalletForm(){
  state.ui.editingWalletId = null;
  document.getElementById('wName').value='';
  document.getElementById('wType').value='bank';
  document.getElementById('wBlkBalance').style.display='block';
  document.getElementById('wBlkCredit').style.display='none';
  document.getElementById('wBalance').value='';
  document.getElementById('wLimit').value='';
  document.getElementById('wIconPreview').textContent='üíº';
  document.getElementById('btnAddWallet').disabled=false;
  document.getElementById('btnUpdateWallet').disabled=true;
  document.getElementById('btnCancelEditWallet').disabled=true;
}
function startEditWallet(id){
  const w = state.wallets.find(x=>x.id===id); if(!w) return;
  state.ui.editingWalletId = id;
  document.getElementById('wName').value=w.name||'';
  document.getElementById('wType').value=w.type||'bank';
  document.getElementById('wIconPreview').innerHTML = (w.icon && String(w.icon).startsWith('data:image')) ? `<img src="${w.icon}">` : (w.icon||'üíº');
  if(w.type==='credit'){
    document.getElementById('wBlkBalance').style.display='none';
    document.getElementById('wBlkCredit').style.display='block';
    document.getElementById('wLimit').value=w.creditLimit||0;
  }else{
    document.getElementById('wBlkBalance').style.display='block';
    document.getElementById('wBlkCredit').style.display='none';
    document.getElementById('wBalance').value=w.balance||0;
  }
  document.getElementById('btnAddWallet').disabled=true;
  document.getElementById('btnUpdateWallet').disabled=false;
  document.getElementById('btnCancelEditWallet').disabled=false;
}
async function deleteWallet(id){
  const w = state.wallets.find(x=>x.id===id);
  if(!w) return;
  if(!confirm(`‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ "${w.name}" ?`)) return;
  apply({ ...state, wallets: state.wallets.filter(x=>x.id!==id) });
}
document.getElementById('wType').addEventListener('change', e=>{
  const v=e.target.value;
  document.getElementById('wBlkBalance').style.display = (v==='credit')?'none':'block';
  document.getElementById('wBlkCredit').style.display  = (v==='credit')?'block':'none';
});
document.getElementById('btnPickWalletEmoji').addEventListener('click', async ()=>{
  const em = await openEmojiPicker(); document.getElementById('wIconPreview').textContent = em;
});
document.getElementById('btnAddWallet').addEventListener('click', ()=>{
  const name = document.getElementById('wName').value.trim();
  const type = document.getElementById('wType').value;
  const iconEl = document.getElementById('wIconPreview');
  const icon = iconEl.querySelector('img') ? iconEl.querySelector('img').src : iconEl.textContent || 'üíº';
  const balance = Number(document.getElementById('wBalance').value||0);
  const limit = Number(document.getElementById('wLimit').value||0);
  if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤');
  let wallet = { id: crypto.randomUUID(), name, type, icon, updatedAt: nowISO() };
  if(type==='credit'){ wallet.creditLimit = limit; wallet.availableCredit = limit; }
  else { wallet.balance = balance; }
  apply({ ...state, wallets: [...state.wallets, wallet] });
  resetWalletForm();
});
document.getElementById('btnUpdateWallet').addEventListener('click', ()=>{
  const id = state.ui.editingWalletId; if(!id) return;
  const name = document.getElementById('wName').value.trim();
  const type = document.getElementById('wType').value;
  const iconEl = document.getElementById('wIconPreview');
  const icon = iconEl.querySelector('img') ? iconEl.querySelector('img').src : iconEl.textContent || 'üíº';
  const balance = Number(document.getElementById('wBalance').value||0);
  const limit = Number(document.getElementById('wLimit').value||0);
  let wallets = state.wallets.map(w=>{
    if(w.id!==id) return w;
    let nw = {...w, name, type, icon, updatedAt: nowISO() };
    if(type==='credit'){ nw.creditLimit = limit; nw.availableCredit = Math.min(nw.availableCredit||limit, limit); delete nw.balance; }
    else { nw.balance = balance; delete nw.creditLimit; delete nw.availableCredit; }
    return nw;
  });
  apply({ ...state, wallets });
  resetWalletForm();
});
document.getElementById('btnCancelEditWallet').addEventListener('click', resetWalletForm);

/* -------------------- Credit payment & Installment -------------------- */
document.getElementById('btnPay').addEventListener('click', ()=>{
  const from = document.getElementById('payFrom').value;
  const card = document.getElementById('payCard').value;
  const amt = Number(document.getElementById('payAmt').value||0);
  if(!from || !card || !amt) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const tx = { id: crypto.randomUUID(), date: todayStr(), type:'transfer', walletId: from, toWalletId: card, amount: amt, note: '‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', updatedAt: nowISO() };
  apply({ ...state, transactions: [...state.transactions, tx] });
  document.getElementById('payAmt').value='';
});
document.getElementById('btnCreatePlan').addEventListener('click', ()=>{
  const walletId = document.getElementById('instWallet').value;
  const desc = document.getElementById('instDesc').value.trim();
  const total = Number(document.getElementById('instTotal').value||0);
  const months = Number(document.getElementById('instMonths').value||0);
  const start = document.getElementById('instStart').value || todayStr();
  if(!walletId || !total || !months) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const per = Math.round((total/months)*100)/100;
  const plan = { id: crypto.randomUUID(), walletId, desc, total, months, perMonth: per, startDate: start, paidCount: 0, nextDue: start, active: true, updatedAt: nowISO() };
  apply({ ...state, installmentPlans: [...(state.installmentPlans||[]), plan] });
});
function cancelPlan(id){
  if(!confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?')) return;
  const plans = (state.installmentPlans||[]).map(p=> p.id===id ? {...p, active:false, updatedAt: nowISO()} : p);
  apply({ ...state, installmentPlans: plans });
}
function sameMonth(d1, d2){ const a=new Date(d1), b=new Date(d2); return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }
function addMonth(dateStr){ const d=new Date(dateStr); d.setMonth(d.getMonth()+1); return d.toISOString().slice(0,10); }
function postOneInstallment(id, force=false){
  const p = (state.installmentPlans||[]).find(x=>x.id===id); if(!p || p.active===false) return;
  const today = todayStr();
  if(!force && new Date(today) < new Date(p.nextDue||p.startDate)) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ');
  if((p.paidCount||0) >= (p.months||0)) return alert('‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  // add expense on the credit wallet
  const tx = { id: crypto.randomUUID(), date: p.nextDue || today, type:'expense', walletId: p.walletId, amount: p.perMonth, category:'‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', platform:'', note: p.desc || '‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', updatedAt: nowISO() };
  const newPaid = (p.paidCount||0)+1;
  const nextDue = newPaid>=p.months ? null : addMonth(p.nextDue || p.startDate);
  const plans = state.installmentPlans.map(x=> x.id===id ? {...x, paidCount:newPaid, nextDue, updatedAt: nowISO()} : x);
  apply({ ...state, installmentPlans: plans, transactions: [...state.transactions, tx] });
}
function runInstallmentScheduler(){
  // auto-post if today >= nextDue and not already posted this month
  const today = todayStr();
  (state.installmentPlans||[]).forEach(p=>{
    if(p.active===false) return;
    if((p.paidCount||0) >= (p.months||0)) return;
    const due = p.nextDue || p.startDate;
    if(new Date(today) < new Date(due)) return;
    // check if already posted for the same month
    const exists = state.transactions.some(tx => tx.type==='expense' && tx.walletId===p.walletId && tx.note===p.desc && sameMonth(tx.date, due));
    if(!exists){
      postOneInstallment(p.id, true);
    }
  });
}

/* -------------------- Categories CRUD -------------------- */
function resetCatForm(){
  state.ui.editingCatId = null;
  document.getElementById('catName').value='';
  document.getElementById('catIconPreview').textContent='üè∑Ô∏è';
  document.getElementById('btnAddCat').disabled=false;
  document.getElementById('btnUpdateCat').disabled=true;
  document.getElementById('btnCancelEditCat').disabled=true;
}
document.getElementById('btnPickCatEmoji').addEventListener('click', async ()=>{
  const em = await openEmojiPicker(); document.getElementById('catIconPreview').textContent = em;
});
document.getElementById('btnAddCat').addEventListener('click', ()=>{
  const name = document.getElementById('catName').value.trim();
  const iconEl = document.getElementById('catIconPreview');
  const icon = iconEl.querySelector('img') ? iconEl.querySelector('img').src : iconEl.textContent || 'üè∑Ô∏è';
  if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î');
  const item = { id: crypto.randomUUID(), name, icon, updatedAt: nowISO() };
  apply({ ...state, categories: [...state.categories, item] });
  resetCatForm();
});
function startEditCategory(id){
  const c = state.categories.find(x=>x.id===id); if(!c) return;
  state.ui.editingCatId = id;
  document.getElementById('catName').value=c.name||'';
  document.getElementById('catIconPreview').innerHTML = (c.icon && String(c.icon).startsWith('data:image')) ? `<img src="${c.icon}">` : (c.icon||'üè∑Ô∏è');
  document.getElementById('btnAddCat').disabled=true;
  document.getElementById('btnUpdateCat').disabled=false;
  document.getElementById('btnCancelEditCat').disabled=false;
}
document.getElementById('btnUpdateCat').addEventListener('click', ()=>{
  const id = state.ui.editingCatId; if(!id) return;
  const name = document.getElementById('catName').value.trim();
  const iconEl = document.getElementById('catIconPreview');
  const icon = iconEl.querySelector('img') ? iconEl.querySelector('img').src : iconEl.textContent || 'üè∑Ô∏è';
  const categories = state.categories.map(c=> c.id===id ? {...c, name, icon, updatedAt: nowISO()} : c);
  apply({ ...state, categories });
  resetCatForm();
});
document.getElementById('btnCancelEditCat').addEventListener('click', resetCatForm);
function deleteCategory(id){
  const c = state.categories.find(x=>x.id===id); if(!c) return;
  if(!confirm(`‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î "${c.name}" ?`)) return;
  apply({ ...state, categories: state.categories.filter(x=>x.id!==id) });
}

/* -------------------- Platforms CRUD -------------------- */
function resetPlatForm(){
  state.ui.editingPlatId = null;
  document.getElementById('platName').value='';
  document.getElementById('platIconPreview').textContent='üõçÔ∏è';
  document.getElementById('btnAddPlat').disabled=false;
  document.getElementById('btnUpdatePlat').disabled=true;
  document.getElementById('btnCancelEditPlat').disabled=true;
  document.getElementById('platIconFile').value='';
}
document.getElementById('btnPickPlatEmoji').addEventListener('click', async ()=>{
  const em = await openEmojiPicker(); document.getElementById('platIconPreview').textContent = em;
});
document.getElementById('platIconFile').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = () => {
    document.getElementById('platIconPreview').innerHTML = `<img src="${rd.result}">`;
  };
  rd.readAsDataURL(f);
});
document.getElementById('btnAddPlat').addEventListener('click', ()=>{
  const name = document.getElementById('platName').value.trim();
  const iconEl = document.getElementById('platIconPreview');
  const icon = iconEl.querySelector('img') ? iconEl.querySelector('img').src : iconEl.textContent || 'üõçÔ∏è';
  if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏£‡πâ‡∏≤‡∏ô');
  const item = { id: crypto.randomUUID(), name, icon, updatedAt: nowISO() };
  apply({ ...state, platforms: [...state.platforms, item] });
  resetPlatForm();
});
function startEditPlatform(id){
  const p = state.platforms.find(x=>x.id===id); if(!p) return;
  state.ui.editingPlatId = id;
  document.getElementById('platName').value=p.name||'';
  document.getElementById('platIconPreview').innerHTML = (p.icon && String(p.icon).startsWith('data:image')) ? `<img src="${p.icon}">` : (p.icon||'üõçÔ∏è');
  document.getElementById('btnAddPlat').disabled=true;
  document.getElementById('btnUpdatePlat').disabled=false;
  document.getElementById('btnCancelEditPlat').disabled=false;
}
document.getElementById('btnUpdatePlat').addEventListener('click', ()=>{
  const id = state.ui.editingPlatId; if(!id) return;
  const name = document.getElementById('platName').value.trim();
  const iconEl = document.getElementById('platIconPreview');
  const icon = iconEl.querySelector('img') ? iconEl.querySelector('img').src : iconEl.textContent || 'üõçÔ∏è';
  const platforms = state.platforms.map(p=> p.id===id ? {...p, name, icon, updatedAt: nowISO()} : p);
  apply({ ...state, platforms });
  resetPlatForm();
});
document.getElementById('btnCancelEditPlat').addEventListener('click', resetPlatForm);
function deletePlatform(id){
  const p = state.platforms.find(x=>x.id===id); if(!p) return;
  if(!confirm(`‡∏•‡∏ö "${p.name}" ?`)) return;
  apply({ ...state, platforms: state.platforms.filter(x=>x.id!==id) });
}

/* -------------------- Transactions CRUD -------------------- */
document.getElementById('tType').addEventListener('change', e=>{
  const v=e.target.value;
  document.getElementById('blkTo').style.display = (v==='transfer')?'block':'none';
  document.getElementById('lblFrom').textContent = (v==='income')?'‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤':'‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤';
  document.getElementById('blkCatPlat').style.display = (v==='transfer')?'none':'block';
});
document.getElementById('btnAddTx').addEventListener('click', ()=>{
  const date = document.getElementById('tDate').value || todayStr();
  const type = document.getElementById('tType').value;
  const walletId = document.getElementById('tFrom').value;
  const toWalletId = document.getElementById('tTo').value || undefined;
  const amount = Number(document.getElementById('tAmt').value||0);
  const category = document.getElementById('tCat').value.trim();
  const platform = document.getElementById('tPlat').value.trim();
  const note = document.getElementById('tNote').value.trim();
  if(!walletId || !amount) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
  const tx = { id: crypto.randomUUID(), date, type, walletId, toWalletId, amount, category, platform, note, updatedAt: nowISO() };
  apply({ ...state, transactions: [...state.transactions, tx] });
  document.getElementById('tAmt').value=''; document.getElementById('tCat').value=''; document.getElementById('tPlat').value=''; document.getElementById('tNote').value='';
});
function editTx(id){
  const t = state.transactions.find(x=>x.id===id); if(!t) return;
  const el = document.createElement('div'); el.className='stack';
  el.innerHTML = `
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="mDate" type="date" value="${t.date}">
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
    <select id="mType">
      <option value="income"${t.type==='income'?' selected':''}>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
      <option value="expense"${t.type==='expense'?' selected':''}>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
      <option value="transfer"${t.type==='transfer'?' selected':''}>‡πÇ‡∏≠‡∏ô/‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</option>
    </select>
    <label>‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</label>
    <select id="mFrom"></select>
    <label>‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô)</label>
    <select id="mTo"></select>
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="mAmt" type="number" value="${t.amount}">
    <label>‡∏´‡∏°‡∏ß‡∏î</label><input id="mCat" value="${t.category||''}" list="dlCats">
    <label>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label><input id="mPlat" value="${t.platform||''}" list="dlPlats">
    <label>‡πÇ‡∏ô‡πâ‡∏ï</label><textarea id="mNote">${t.note||''}</textarea>
  `;
  const mFrom = el.querySelector('#mFrom'), mTo = el.querySelector('#mTo');
  state.wallets.forEach(w=>{
    const o=document.createElement('option'); o.value=w.id; o.textContent=w.name; if(w.id===t.walletId) o.selected=true; mFrom.appendChild(o);
    const o2=document.createElement('option'); o2.value=w.id; o2.textContent=w.name; if(w.id===t.toWalletId) o2.selected=true; mTo.appendChild(o2);
  });
  openModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', el, ()=>{
    const nt = {
      ...t,
      date: el.querySelector('#mDate').value || t.date,
      type: el.querySelector('#mType').value,
      walletId: el.querySelector('#mFrom').value,
      toWalletId: el.querySelector('#mTo').value || undefined,
      amount: Number(el.querySelector('#mAmt').value||0),
      category: el.querySelector('#mCat').value.trim(),
      platform: el.querySelector('#mPlat').value.trim(),
      note: el.querySelector('#mNote').value.trim(),
      updatedAt: nowISO()
    };
    apply({ ...state, transactions: state.transactions.map(x=> x.id===id ? nt : x) });
  });
}
function deleteTx(id){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  apply({ ...state, transactions: state.transactions.filter(x=>x.id!==id) });
}

/* -------------------- Filters -------------------- */
document.getElementById('txFilterField').addEventListener('change', renderTxTableAll);
document.getElementById('txFilterQuery').addEventListener('input', renderTxTableAll);
document.getElementById('btnClearFilter').addEventListener('click', ()=>{ document.getElementById('txFilterQuery').value=''; renderTxTableAll(); });

/* -------------------- Settings & Sync -------------------- */
document.getElementById('btnSaveSync').addEventListener('click', async ()=>{
  state.cfg.gsUrl = document.getElementById('gsUrl').value.trim();
  state.cfg.gsKey = document.getElementById('gsKey').value.trim();
  save(state);
  if(!state.cfg.gsUrl) return alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL)');
  try{
    setSyncStatus('pulling');
    const remote = await gsPullAll();
    const isEmpty = (remote.wallets?.length||0)+(remote.transactions?.length||0)===0;
    if(isEmpty){ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à & ‡∏≠‡∏±‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï'); }
    else { const merged = mergeStateLWW(state, remote); apply(merged, {skipSync:true}); setSyncStatus('idle'); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à & ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); }
  }catch(e){ console.error(e); setSyncStatus('error'); alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à URL/Key'); }
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á?')){ localStorage.removeItem(LS_KEY); state = defaultState(); apply(state, {skipSync:true}); }
});
document.getElementById('btnSync').addEventListener('click', async ()=>{
  if(!state.cfg.gsUrl) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
  try{ setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle'); alert('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß'); }
  catch(e){ console.error(e); setSyncStatus('error'); alert('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); }
});
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'income-expense-backup.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('fileImport').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = () => { try{ const s = JSON.parse(rd.result); apply(s, {skipSync:true}); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'); }catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } };
  rd.readAsText(f);
});

/* -------------------- Tabs -------------------- */
document.querySelectorAll('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{
  const t = btn.dataset.tab;
  document.getElementById('tab-dashboard').style.display   = (t==='dashboard')?'grid':'none';
  document.getElementById('tab-wallets').style.display     = (t==='wallets')?'grid':'none';
  document.getElementById('tab-transactions').style.display= (t==='transactions')?'block':'none';
  document.getElementById('tab-categories').style.display  = (t==='categories')?'grid':'none';
  document.getElementById('tab-platforms').style.display   = (t==='platforms')?'grid':'none';
  document.getElementById('tab-add').style.display         = (t==='add')?'grid':'none';
  document.getElementById('tab-settings').style.display    = (t==='settings')?'block':'none';
}));

// Dashboard timeframe controls
const dashSel = document.getElementById('dashRange');
const dashFrom = document.getElementById('dashFrom');
const dashTo = document.getElementById('dashTo');
const dashSep = dashFrom.nextElementSibling; // span ‚Äì
dashSel.addEventListener('change', ()=>{
  const v = dashSel.value;
  state.ui.dash.mode = v;
  const show = (v==='custom');
  dashFrom.style.display = show?'inline-block':'none';
  dashSep.style.display = show?'inline-block':'none';
  dashTo.style.display = show?'inline-block':'none';
  apply(state, {skipSync:true});
});
[dashFrom, dashTo].forEach(inp=>inp.addEventListener('change', ()=>{
  state.ui.dash.from = dashFrom.value;
  state.ui.dash.to = dashTo.value;
  apply(state, {skipSync:true});
}));

/* -------------------- Boot -------------------- */
async function boot(){
  // Prefill date & timeframe
  document.getElementById('tDate').value = todayStr();
  // Init custom range defaults
  dashFrom.value = todayStr();
  dashTo.value = todayStr();
  dashSel.value = state.ui?.dash?.mode || 'thisMonth';
  if(dashSel.value==='custom'){
    dashFrom.style.display='inline-block'; dashSep.style.display='inline-block'; dashTo.style.display='inline-block';
    dashFrom.value = state.ui?.dash?.from || todayStr();
    dashTo.value = state.ui?.dash?.to || todayStr();
  }

  render();

  // Pull from remote and merge (keeping seed-guard from previous logic)
  if(state.cfg.gsUrl){
    try{
      setSyncStatus('pulling');
      const remote = await gsPullAll();
      const isEmpty = (remote.wallets?.length||0) + (remote.transactions?.length||0) === 0;

      const localLooksSeed =
        (state.wallets?.length === 2 && state.transactions?.length === 0) &&
        state.wallets.some(w => w.name === '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å') &&
        state.wallets.some(w => w.name === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï A');

      if (!isEmpty && localLooksSeed) {
        state = recalcBalances({ ...state,
          wallets: remote.wallets,
          transactions: remote.transactions,
          installmentPlans: remote.installmentPlans || []
        });
        save(state); render(); setSyncStatus('idle');
      } else if(isEmpty){
        setSyncStatus('pushing'); await gsPushAll(state); setSyncStatus('idle');
      } else {
        const merged = mergeStateLWW(state, remote);
        apply(merged, {skipSync:true}); setSyncStatus('idle');
      }
    }catch(e){ console.error(e); setSyncStatus('error'); }
  }

  // Auto post installments if needed (after sync)
  runInstallmentScheduler();
}
boot();
</script>
</body>
</html>
