
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>สมุดรายรับรายจ่าย (CORS Fixed)</title>
</head>
<body>
<h2>สมุดรายรับรายจ่าย (CORS Fixed Version)</h2>
<p>เวอร์ชันนี้แก้ปัญหา CORS แล้ว สามารถใช้งานผ่าน GitHub Pages ได้</p>
<script>
const state = { cfg: { 
  gsUrl: "https://script.google.com/macros/s/AKfycbzHnFO495JmY8oI_1qoygD6-55pmoZg-eeHzoLUQk0XNlbRKahyRbXmW-AIRLaQbtY1/exec", 
  gsKey: "boss_2f8c3a1e9d9b4d7abcf1e9f3d8a4e6c1" 
}};

function withQuery(base, params){
  const url = new URL(base);
  Object.entries(params||{}).forEach(([k,v])=>{ 
    if(v!==undefined && v!==null && v!=='') url.searchParams.set(k, String(v)); 
  });
  return url.toString();
}

async function gsFetch(entity, op, payload){
  if(!state.cfg.gsUrl) throw new Error('ยังไม่ตั้งค่า gsUrl');

  // สำหรับ list ใช้ GET ไม่มี header => ไม่โดน CORS
  if (op === 'list') {
    const url = withQuery(state.cfg.gsUrl, { entity, op, apiKey: state.cfg.gsKey });
    const res = await fetch(url, { method: 'GET' });
    const data = await res.json();
    if (data && data.ok === false) throw new Error(data.error || 'API error');
    return data;
  }

  // สำหรับ replaceAll ใช้ POST แบบ simple (ไม่ตั้ง header)
  if (entity === 'bulk' && op === 'replaceAll') {
    const url = withQuery(state.cfg.gsUrl, { entity, op, apiKey: state.cfg.gsKey });
    const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload || {}) });
    const data = await res.json();
    if (data && data.ok === false) throw new Error(data.error || 'API error');
    return data;
  }

  throw new Error('Unknown gsFetch op');
}

async function test(){
  try {
    const data = await gsFetch("wallets", "list");
    document.body.insertAdjacentHTML('beforeend', `<pre>${JSON.stringify(data,null,2)}</pre>`);
  } catch(e){
    document.body.insertAdjacentHTML('beforeend', `<pre style="color:red">${e}</pre>`);
  }
}

test();
</script>
</body>
</html>
